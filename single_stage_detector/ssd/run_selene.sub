#!/usr/bin/env bash

set -euxo pipefail

export RESULTS_DIR="./results"
mkdir -p ${RESULTS_DIR}

echo $CONT
echo $DATADIR
echo $BACKBONE_DIR

srun \
    --mpi=none \
    --ntasks="$(( DGXNNODES * DGXNGPU ))" \
    --ntasks-per-node="${DGXNGPU}" \
    --container-image="${CONT}" \
    --container-workdir=/ssd \
    --container-mounts=$(pwd):/ssd,${DATADIR}:/datasets/open-images-v6-mlperf,${BACKBONE_DIR}:/torch-home,${RESULTS_DIR}:/results \
    ./run_and_time.sh
